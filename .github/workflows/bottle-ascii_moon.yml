name: Bottle ascii_moon

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - ascii_moon.rb

permissions:
  contents: write

concurrency:
  group: bottle-ascii_moon-${{ github.ref }}
  cancel-in-progress: false

env:
  HOMEBREW_NO_ANALYTICS: 1
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_INSTALL_CLEANUP: 1
  # Prevent setup-homebrew from moving the tap checkout into $GITHUB_WORKSPACE
  # and creating a symlink that our workflow can accidentally replace.
  GITHUB_ACTIONS_HOMEBREW_SELF_HOSTED: 1

jobs:
  build:
    if: github.actor != 'github-actions[bot]'
    name: Build bottle (${{ matrix.runner }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        runner:
          # Intel macOS
          - macos-15-intel
          # Apple Silicon macOS
          - macos-15
          # Linux x86_64
          - ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Install (build bottle)
        shell: bash
        run: |
          set -euo pipefail
          brew install --build-bottle rockydd/homebrew-tap/ascii_moon

      - name: Compute bottle tag + root_url
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(brew ruby -e 'puts Formulary.factory("rockydd/homebrew-tap/ascii_moon").version')"
          TAG="ascii_moon-bottle-v${VERSION}"
          ROOT_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}"
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "tag=${TAG}" >> "${GITHUB_OUTPUT}"
          echo "root_url=${ROOT_URL}" >> "${GITHUB_OUTPUT}"

      - name: Bottle (generate tarball + JSON)
        shell: bash
        run: |
          set -euo pipefail
          brew bottle --json --root-url="${{ steps.meta.outputs.root_url }}" rockydd/homebrew-tap/ascii_moon
          ls -la

      - name: Upload bottle artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bottles-${{ matrix.runner }}
          path: |
            *.bottle*.tar.gz
            *.json
          if-no-files-found: error

  publish:
    if: github.actor != 'github-actions[bot]'
    name: Publish bottles + update formula
    runs-on: ubuntu-22.04
    needs: build

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Download bottle artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare artifacts (flatten)
        shell: bash
        run: |
          set -euo pipefail
          find artifacts -type f -maxdepth 3 -print
          mkdir -p dist
          find artifacts -type f -name '*.tar.gz' -exec cp {} dist/ \;
          find artifacts -type f -name '*.json' -exec cp {} dist/ \;
          ls -la dist

      - name: Compute bottle tag + root_url
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(brew ruby -e 'puts Formulary.factory("rockydd/homebrew-tap/ascii_moon").version')"
          TAG="ascii_moon-bottle-v${VERSION}"
          ROOT_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}"
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "tag=${TAG}" >> "${GITHUB_OUTPUT}"
          echo "root_url=${ROOT_URL}" >> "${GITHUB_OUTPUT}"

      - name: Create (or reuse) GitHub Release for bottles
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.meta.outputs.tag }}"
          if gh release view "${TAG}" --repo "${GITHUB_REPOSITORY}" >/dev/null 2>&1; then
            echo "Release ${TAG} already exists; reusing."
          else
            gh release create "${TAG}" \
              --repo "${GITHUB_REPOSITORY}" \
              --title "Bottles: ascii_moon v${{ steps.meta.outputs.version }}" \
              --notes "Automated bottles for ascii_moon v${{ steps.meta.outputs.version }}."
          fi

      - name: Upload bottle tarballs to GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          gh release upload "${{ steps.meta.outputs.tag }}" *.bottle*.tar.gz \
            --repo "${GITHUB_REPOSITORY}" \
            --clobber

      - name: Merge bottle JSON into formula
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          shopt -s nullglob
          JSONS=( *.json )
          if [ "${#JSONS[@]}" -eq 0 ]; then
            echo "No JSON files found in dist/"
            exit 1
          fi
          # Apply merges deterministically.
          for j in "${JSONS[@]}"; do
            brew bottle --merge --write --no-commit "${j}"
          done

      - name: Sync formula back into workspace
        shell: bash
        run: |
          set -euo pipefail
          cp "$(brew --repo rockydd/homebrew-tap)/ascii_moon.rb" "${GITHUB_WORKSPACE}/ascii_moon.rb"

      - name: Commit formula changes (bottle block)
        shell: bash
        run: |
          set -euo pipefail
          git status --porcelain
          if git diff --quiet; then
            echo "No formula changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ascii_moon.rb
          git commit -m "ascii_moon: add bottles for v${{ steps.meta.outputs.version }}"
          git push



