name: Bottle ascii_moon

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - ascii_moon.rb

permissions:
  contents: write

concurrency:
  group: bottle-ascii_moon-${{ github.ref }}
  cancel-in-progress: false

env:
  HOMEBREW_NO_ANALYTICS: 1
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_INSTALL_CLEANUP: 1
  # Prevent setup-homebrew from moving the tap checkout into $GITHUB_WORKSPACE
  # and creating a symlink that our workflow can accidentally replace.
  GITHUB_ACTIONS_HOMEBREW_SELF_HOSTED: 1

jobs:
  changes:
    name: Detect formula bump
    runs-on: ubuntu-22.04
    outputs:
      should_build: ${{ steps.detect.outputs.should_build }}
      reason: ${{ steps.detect.outputs.reason }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect whether url/sha256 changed
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          # Always allow manual runs.
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            echo "should_build=true" >> "${GITHUB_OUTPUT}"
            echo "reason=workflow_dispatch" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          # If this is the first commit on a branch, be conservative and build.
          if [[ -z "${BEFORE}" || "${BEFORE}" == "0000000000000000000000000000000000000000" ]]; then
            echo "should_build=true" >> "${GITHUB_OUTPUT}"
            echo "reason=no_before_sha" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          # Use POSIX tools only (GitHub runners may not have ripgrep installed).
          old_url="$(git show "${BEFORE}:ascii_moon.rb" | grep -E '^[[:space:]]*url[[:space:]]+"' | head -n 1 || true)"
          new_url="$(git show "${AFTER}:ascii_moon.rb" | grep -E '^[[:space:]]*url[[:space:]]+"' | head -n 1 || true)"
          old_sha="$(git show "${BEFORE}:ascii_moon.rb" | grep -E '^[[:space:]]*sha256[[:space:]]+"' | head -n 1 || true)"
          new_sha="$(git show "${AFTER}:ascii_moon.rb" | grep -E '^[[:space:]]*sha256[[:space:]]+"' | head -n 1 || true)"

          if [[ "${old_url}" != "${new_url}" || "${old_sha}" != "${new_sha}" ]]; then
            echo "should_build=true" >> "${GITHUB_OUTPUT}"
            echo "reason=version_bump" >> "${GITHUB_OUTPUT}"
          else
            echo "should_build=false" >> "${GITHUB_OUTPUT}"
            echo "reason=no_url_sha_change" >> "${GITHUB_OUTPUT}"
          fi

  build:
    if: github.actor != 'github-actions[bot]' && needs.changes.outputs.should_build == 'true'
    name: Build bottle (${{ matrix.runner }})
    runs-on: ${{ matrix.runner }}
    needs: changes
    strategy:
      fail-fast: false
      matrix:
        runner:
          # Intel macOS
          - macos-15-intel
          # Apple Silicon macOS
          - macos-15
          # Linux x86_64
          - ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Install (build bottle)
        shell: bash
        run: |
          set -euo pipefail
          brew install --build-bottle rockydd/homebrew-tap/ascii_moon

      - name: Compute bottle tag + root_url
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(brew ruby -e 'puts Formulary.factory("rockydd/homebrew-tap/ascii_moon").version')"
          TAG="ascii_moon-bottle-v${VERSION}"
          ROOT_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}"
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "tag=${TAG}" >> "${GITHUB_OUTPUT}"
          echo "root_url=${ROOT_URL}" >> "${GITHUB_OUTPUT}"

      - name: Bottle (generate tarball + JSON)
        shell: bash
        run: |
          set -euo pipefail
          brew bottle --json --root-url="${{ steps.meta.outputs.root_url }}" rockydd/homebrew-tap/ascii_moon
          ls -la

      - name: Upload bottle artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bottles-${{ matrix.runner }}
          path: |
            *.bottle*.tar.gz
            *.json
          if-no-files-found: error

  publish:
    if: github.actor != 'github-actions[bot]' && needs.changes.outputs.should_build == 'true'
    name: Publish bottles + update formula
    runs-on: ubuntu-22.04
    needs: [changes, build]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Download bottle artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare artifacts (flatten)
        shell: bash
        run: |
          set -euo pipefail
          find artifacts -type f -maxdepth 3 -print
          mkdir -p dist
          find artifacts -type f -name '*.tar.gz' -exec cp {} dist/ \;
          find artifacts -type f -name '*.json' -exec cp {} dist/ \;
          ls -la dist

      - name: Compute bottle tag + root_url
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(brew ruby -e 'puts Formulary.factory("rockydd/homebrew-tap/ascii_moon").version')"
          TAG="ascii_moon-bottle-v${VERSION}"
          ROOT_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}"
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "tag=${TAG}" >> "${GITHUB_OUTPUT}"
          echo "root_url=${ROOT_URL}" >> "${GITHUB_OUTPUT}"

      - name: Create (or reuse) GitHub Release for bottles
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.meta.outputs.tag }}"
          if gh release view "${TAG}" --repo "${GITHUB_REPOSITORY}" >/dev/null 2>&1; then
            echo "Release ${TAG} already exists; reusing."
          else
            gh release create "${TAG}" \
              --repo "${GITHUB_REPOSITORY}" \
              --title "Bottles: ascii_moon v${{ steps.meta.outputs.version }}" \
              --notes "Automated bottles for ascii_moon v${{ steps.meta.outputs.version }}."
          fi

      - name: Combine bottle JSON (all platforms)
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          python3 - <<'PY'
          import glob, json, sys
          files = sorted(glob.glob("*.json"))
          if not files:
            print("No JSON files found in dist/", file=sys.stderr)
            sys.exit(1)
          combined = {}
          for path in files:
            with open(path, "r", encoding="utf-8") as f:
              data = json.load(f)
            if not isinstance(data, dict):
              raise SystemExit(f"{path}: expected JSON object at top-level")
            for formula_key, payload in data.items():
              if formula_key not in combined:
                combined[formula_key] = payload
                continue
              # Merge bottle tags across platforms.
              cb = combined[formula_key].get("bottle") or {}
              nb = payload.get("bottle") or {}
              for k in ("root_url", "cellar"):
                if k in cb and k in nb and cb[k] != nb[k]:
                  raise SystemExit(f"{path}: bottle.{k} mismatch for {formula_key}: {cb[k]} != {nb[k]}")
              cb.setdefault("root_url", nb.get("root_url"))
              cb.setdefault("cellar", nb.get("cellar"))
              cb["rebuild"] = max(int(cb.get("rebuild", 0) or 0), int(nb.get("rebuild", 0) or 0))
              cb.setdefault("tags", {})
              cb_tags = cb["tags"]
              nb_tags = nb.get("tags") or {}
              if not isinstance(cb_tags, dict) or not isinstance(nb_tags, dict):
                raise SystemExit(f"{path}: bottle.tags must be an object for {formula_key}")
              cb_tags.update(nb_tags)
              combined[formula_key]["bottle"] = cb
          with open("combined.json", "w", encoding="utf-8") as f:
            json.dump(combined, f, indent=2, sort_keys=True)
            f.write("\n")
          print(f"Wrote combined.json from {len(files)} files")
          PY

      - name: Rename bottle tarballs to expected filenames
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          python3 - <<'PY'
          import json, os, sys
          with open("combined.json", "r", encoding="utf-8") as f:
            data = json.load(f)
          for formula_key, payload in data.items():
            bottle = (payload or {}).get("bottle") or {}
            tags = bottle.get("tags") or {}
            if not isinstance(tags, dict):
              continue
            for tag, info in tags.items():
              if not isinstance(info, dict):
                continue
              src = info.get("local_filename")
              dst = info.get("filename")
              if not src or not dst or src == dst:
                continue
              if os.path.exists(src) and not os.path.exists(dst):
                os.rename(src, dst)
          PY
          ls -la

      - name: Upload bottle tarballs to GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          gh release upload "${{ steps.meta.outputs.tag }}" *.bottle*.tar.gz \
            --repo "${GITHUB_REPOSITORY}" \
            --clobber

      - name: Merge bottle JSON into formula
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          brew bottle --merge --write --no-commit ./combined.json

      - name: Sync formula back into workspace
        shell: bash
        run: |
          set -euo pipefail
          cp "$(brew --repo rockydd/homebrew-tap)/ascii_moon.rb" "${GITHUB_WORKSPACE}/ascii_moon.rb"

      - name: Commit formula changes (bottle block)
        shell: bash
        run: |
          set -euo pipefail
          git status --porcelain
          if git diff --quiet; then
            echo "No formula changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ascii_moon.rb
          git commit -m "ascii_moon: add bottles for v${{ steps.meta.outputs.version }}"
          git push



